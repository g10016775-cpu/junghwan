# [PRD] 북클럽 3.0 하이브리드 설정 시스템

**프로젝트명**: Universal Settings
**문서 버전**: v1.0
**작성일**: 2025-02-10
**상태**: 🟢 Ready for Development

---

## 📋 목차

1. [개요 및 목적](#1-개요-및-목적)
2. [사용자 유형별 설정 정의](#2-사용자-유형별-설정-정의)
3. [핵심 기능 요구사항](#3-핵심-기능-요구사항)
4. [기술 및 운영 상세](#4-기술-및-운영-상세)
5. [장애 및 보안 시나리오](#5-장애-및-보안-시나리오)
6. [구현 가이드](#6-구현-가이드)

---

## 1. 개요 및 목적

### 1.1 배경

전용 패드(웅진 패드)와 개인 패드(BYOD) 환경이 공존함에 따라, **단말기 권한 및 정규 멤버십 유무에 따른 차별화된 설정 경험 제공** 필요.

**현재 문제점:**
- ❌ 전용 패드와 개인 패드의 설정 화면이 동일
- ❌ 기기 제어 메뉴가 개인 패드에서 작동하지 않음
- ❌ 정규 회원과 일반 회원의 차별화 부족
- ❌ 멤버십 자산(포인트, 구매내역)이 기기 종속적

### 1.2 목적

1. ✅ **전용 패드 사용자의 시스템 설정 및 기존 런처 호환성 유지**
2. ✅ **개인 패드 사용자의 가벼운 서비스 경험 제공**
3. ✅ **정규 멤버십 자산의 계정 기반 동기화**

### 1.3 핵심 가치

```
🎯 하나의 앱, 세 가지 경험
   - 사용자 환경에 따라 최적화된 설정 제공
   - 불필요한 메뉴는 숨기고, 필요한 기능만 노출
   - 계정 기반 자산 관리로 멀티 디바이스 지원
```

---

## 2. 사용자 유형별 설정 정의 (3-Tier Structure)

### 2.1 사용자 타입 분류

| 유형 | 식별 로직 | 주요 메뉴 구성 | 특징 |
|------|----------|---------------|------|
| **Type 1<br>전용 패드 회원** | `is_woongjin_device = true`<br>`is_member = true` | **Full-Set**<br>기기 제어 + 멤버십 관리 + 런처 복귀 | 웅진 전용 패드 사용자<br>모든 기능 접근 가능 |
| **Type 2<br>개인 패드 회원** | `is_woongjin_device = false`<br>`is_member = true` | **Hybrid**<br>앱 설정 + 멤버십 관리 | 개인 기기에서 정규 서비스 이용<br>기기 제어 제외 |
| **Type 3<br>일반 회원** | `is_woongjin_device = false`<br>`is_member = false` | **Light**<br>앱 설정 위주 | 무료 체험 사용자<br>멤버십 메뉴 마스킹 |

---

### 2.2 메뉴 구성 상세

#### Type 1: 전용 패드 회원 🏢

```
┌─────────────────────────────────────┐
│ ⚙️ 설정                             │
├─────────────────────────────────────┤
│                                     │
│ 🎨 북클럽 3.0 전용 기능             │
│   ✓ AI 독서 버디                    │
│   ✓ 시선 추적 시력 보호              │
│   ✓ 자동 재생                       │
│                                     │
│ 📱 기기 제어                        │
│   • 화면 밝기 (슬라이더)             │
│   • 음량 (슬라이더)                  │
│   • 블루라이트 필터 (토글)           │
│   • Wi-Fi (토글)                    │
│                                     │
│ 💎 멤버십                           │
│   • 포인트 통장 (1,250P)            │
│   • 구매 내역                       │
│   • 쿠폰함 (3장)                    │
│                                     │
│ 📚 학습 옵션                        │
│   • 학습 모드 (쉬움/보통/어려움)     │
│   • KRS 자동 조정 (토글)            │
│   • 학습 리포트                     │
│                                     │
│ 🔔 앱 설정                          │
│   • 알림 허용                       │
│   • 버전 정보                       │
│                                     │
│ 👤 계정 관리                        │
│   • 계정 정보                       │
│   • 멤버십 등급 (골드)              │
│   • 계정 탈퇴                       │
│                                     │
├─────────────────────────────────────┤
│ [🚪 로그아웃] [🏠 서비스 나가기]    │
└─────────────────────────────────────┘
```

**하단 버튼:**
- 🚪 **로그아웃**: 계정에서 로그아웃
- 🏠 **서비스 나가기**: 북클럽 3.0 앱 종료 → 웅진 런처로 복귀

---

#### Type 2: 개인 패드 회원 👤

```
┌─────────────────────────────────────┐
│ ⚙️ 설정                             │
├─────────────────────────────────────┤
│                                     │
│ 🎨 북클럽 3.0 전용 기능             │
│   ✓ AI 독서 버디                    │
│   ✓ 시선 추적 시력 보호              │
│   ✓ 자동 재생                       │
│                                     │
│ [📱 기기 제어] ← 숨김               │
│                                     │
│ 💎 멤버십                           │
│   • 포인트 통장 (1,250P)            │
│   • 구매 내역                       │
│   • 쿠폰함 (3장)                    │
│                                     │
│ 📚 학습 옵션                        │
│   • 학습 모드 (쉬움/보통/어려움)     │
│   • KRS 자동 조정 (토글)            │
│   • 학습 리포트                     │
│                                     │
│ 🔔 앱 설정                          │
│   • 알림 허용                       │
│   • 버전 정보                       │
│                                     │
│ 👤 계정 관리                        │
│   • 계정 정보                       │
│   • 멤버십 등급 (골드)              │
│   • 계정 탈퇴                       │
│                                     │
├─────────────────────────────────────┤
│         [🚪 로그아웃]               │
└─────────────────────────────────────┘
```

**하단 버튼:**
- 🚪 **로그아웃**: 계정에서 로그아웃 (단일 버튼)

---

#### Type 3: 일반 회원 🎈

```
┌─────────────────────────────────────┐
│ ⚙️ 설정                             │
├─────────────────────────────────────┤
│                                     │
│ 🎨 북클럽 3.0 전용 기능             │
│   ✓ AI 독서 버디                    │
│   ✓ 시선 추적 시력 보호              │
│   ✓ 자동 재생                       │
│                                     │
│ [📱 기기 제어] ← 숨김               │
│                                     │
│ 💎 멤버십  [🔒 마스킹]              │
│   ┌─────────────────────────────┐  │
│   │  ✨ 정규 회원 전용           │  │
│   │  (클릭 시 회원 전환 유도)    │  │
│   └─────────────────────────────┘  │
│                                     │
│ 📚 학습 옵션  [🔒 마스킹]           │
│   ┌─────────────────────────────┐  │
│   │  ✨ 정규 회원 전용           │  │
│   │  (클릭 시 회원 전환 유도)    │  │
│   └─────────────────────────────┘  │
│                                     │
│ 🔔 앱 설정                          │
│   • 알림 허용                       │
│   • 버전 정보                       │
│                                     │
│ 👤 계정 관리                        │
│   • 계정 정보                       │
│   • 계정 탈퇴                       │
│                                     │
├─────────────────────────────────────┤
│         [🚪 로그아웃]               │
└─────────────────────────────────────┘
```

**마스킹 처리:**
- 멤버십, 학습 옵션 섹션이 블러 처리되고 "✨ 정규 회원 전용" 라벨 표시
- 클릭 시 정규 회원 전환 유도 팝업

---

## 3. 핵심 기능 요구사항 (Detailed Requirements)

### 3.1 다이내믹 메뉴 렌더링 (Dynamic UI)

#### 기기 제어 섹션

**노출 조건:** `is_woongjin_device = true`

**포함 기능:**
- 📱 **화면 밝기**: 0-100% 슬라이더, 안드로이드 시스템 API 호출
- 🔊 **음량**: 0-100% 슬라이더, 미디어/알림 볼륨 제어
- 🌙 **블루라이트 필터**: ON/OFF 토글, 색온도 조절
- 📶 **Wi-Fi**: 연결/해제 토글, 현재 SSID 표시

**기술 구현:**
```java
// Android 밝기 조절 예시
Settings.System.putInt(
  getContentResolver(),
  Settings.System.SCREEN_BRIGHTNESS,
  brightnessValue
);
```

---

#### 멤버십 섹션

**노출 조건:** `is_member = true`

**포함 기능:**
- 💰 **포인트 통장**
  - 실시간 잔액 조회 (API: `/api/v1/points/balance`)
  - 적립/사용 내역 (최근 10건)
  - 소멸 예정 포인트 알림

- 📝 **구매 내역**
  - 지난 30일 구매 목록
  - 영수증 다운로드
  - 환불 요청 기능

- 🎁 **쿠폰함**
  - 사용 가능 쿠폰 목록
  - 쿠폰 등록 (코드 입력)
  - 유효기간 알림

**데이터 동기화:**
```
[서버 DB] ←→ [API] ←→ [앱]
    ↓
계정 기반 저장
→ 멀티 디바이스 동기화
```

---

#### 마스킹 정책 (Type 3)

**마스킹 대상:**
- 💎 멤버십 섹션
- 📚 학습 옵션 섹션

**UI 처리:**
```css
.masked-overlay {
  position: relative;
  opacity: 0.5;
  pointer-events: none;
}

.masked-overlay::after {
  content: '';
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(4px);
}
```

**클릭 이벤트:**
```javascript
onClick={() => {
  showUpgradeModal({
    title: '✨ 정규 회원 전환',
    message: '정규 회원이 되면 더 많은 기능을 이용할 수 있어요!',
    benefits: [
      '포인트 적립 & 사용',
      '구매 내역 관리',
      '맞춤형 학습 옵션',
      '프리미엄 콘텐츠 무제한'
    ]
  });
}}
```

---

### 3.2 학습 옵션 및 자산 연동 (Sync Logic)

#### 학습 옵션 설정

**학습 모드:**
- 😊 **쉬움**: 기본 수준, 쉬운 콘텐츠 위주
- 😎 **보통**: 권장 수준, 균형잡힌 난이도
- 🤓 **어려움**: 도전 수준, 어려운 콘텐츠 우선

**KRS 자동 조정:**
```javascript
// 학습 모드 변경 시 KRS 엔진에 가중치 반영
onLearningModeChange(mode) {
  const weights = {
    easy: { krsOffset: -1, difficultyBias: 0.3 },
    standard: { krsOffset: 0, difficultyBias: 0.5 },
    hard: { krsOffset: +1, difficultyBias: 0.7 }
  };

  updateRecommendationEngine({
    krsLevel: user.krsLevel + weights[mode].krsOffset,
    difficultyBias: weights[mode].difficultyBias
  });
}
```

#### 자산 조회 동기화

**실시간 API 호출:**
```javascript
// 포인트 잔액 조회
GET /api/v1/points/balance
Response: {
  "balance": 1250,
  "expiringPoints": 200,
  "expiryDate": "2025-03-31"
}

// 구매 내역 조회
GET /api/v1/purchases?days=30
Response: {
  "purchases": [
    {
      "id": "P123456",
      "date": "2025-02-08",
      "item": "신비아파트 시리즈",
      "amount": 9900
    }
  ]
}
```

**오차 없는 동기화:**
- 런처와 동일한 API 엔드포인트 사용
- Redis 캐시 공유 (TTL 5분)
- WebSocket을 통한 실시간 업데이트 (선택)

---

### 3.3 종료 UX (Exit Strategy)

#### Type 1: 전용 패드 전용

**"서비스 나가기" 버튼:**
```java
// 북클럽 3.0 앱 종료 → 런처 복귀
public void exitToLauncher() {
  // 1. 현재 앱 종료
  finishAndRemoveTask();

  // 2. 런처 명시적 실행
  Intent launcherIntent = new Intent(Intent.ACTION_MAIN);
  launcherIntent.addCategory(Intent.CATEGORY_HOME);
  launcherIntent.setPackage("com.woongjin.launcher");
  launcherIntent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
  startActivity(launcherIntent);

  // 3. 프로세스 종료
  System.exit(0);
}
```

**UI 배치:**
```
┌─────────────────────────────────────┐
│  [🚪 로그아웃]  [🏠 서비스 나가기]  │
│    (50% 너비)     (50% 너비, 강조)  │
└─────────────────────────────────────┘
```

---

#### Type 2, 3: 개인 패드 전용

**"로그아웃" 버튼:**
```javascript
// 표준 로그아웃 처리
function handleLogout() {
  // 1. 로컬 데이터 삭제
  clearLocalStorage();
  clearCache();

  // 2. 서버 세션 종료
  await fetch('/api/v1/auth/logout', { method: 'POST' });

  // 3. 로그인 화면으로 이동
  navigateTo('/login');
}
```

**UI 배치:**
```
┌─────────────────────────────────────┐
│        [🚪 로그아웃]                │
│         (100% 너비)                 │
└─────────────────────────────────────┘
```

---

## 4. 기술 및 운영 상세 (Technical Specs)

### 4.1 Device Sensing (기기 판별)

#### 방법 1: 단말기 모델명 확인

```kotlin
fun isWoongjinDevice(): Boolean {
  val deviceModel = Build.MODEL
  val deviceManufacturer = Build.MANUFACTURER

  return when {
    deviceModel.contains("WOONGJIN", ignoreCase = true) -> true
    deviceManufacturer.equals("Woongjin", ignoreCase = true) -> true
    else -> false
  }
}
```

#### 방법 2: 전용 런처 설치 여부

```kotlin
fun hasWoongjinLauncher(): Boolean {
  val pm = packageManager
  return try {
    pm.getPackageInfo("com.woongjin.launcher", 0)
    true
  } catch (e: PackageManager.NameNotFoundException) {
    false
  }
}
```

#### 최종 판별 로직

```kotlin
val isWoongjinDevice = isWoongjinDevice() || hasWoongjinLauncher()
val isMember = userService.isMembershipActive()

val userType = when {
  isWoongjinDevice && isMember -> UserType.TYPE1
  !isWoongjinDevice && isMember -> UserType.TYPE2
  !isWoongjinDevice && !isMember -> UserType.TYPE3
  else -> UserType.TYPE3 // Fallback
}
```

---

### 4.2 Settings Persistence (설정 저장)

#### 저장 위치 전략

| 설정 유형 | 저장 위치 | 동기화 | 이유 |
|----------|----------|--------|------|
| **기기 설정**<br>(밝기, 음량 등) | SharedPreferences<br>(로컬) | ❌ 없음 | 기기 종속적 설정 |
| **학습/멤버십 설정**<br>(학습 모드, KRS 등) | 서버 DB | ✅ 계정 기반 | 멀티 디바이스 지원 |
| **앱 설정**<br>(알림, 테마 등) | 서버 DB + 로컬 캐시 | ✅ 계정 기반 | 사용자 경험 일관성 |

#### 구현 예시

```kotlin
// 기기 설정 (로컬)
class DeviceSettingsRepository {
  private val prefs = context.getSharedPreferences("device_settings", MODE_PRIVATE)

  fun saveBrightness(value: Int) {
    prefs.edit().putInt("brightness", value).apply()
  }

  fun getBrightness(): Int {
    return prefs.getInt("brightness", 70)
  }
}

// 학습 설정 (서버)
class LearningSettingsRepository {
  suspend fun saveLearningMode(userId: String, mode: String) {
    api.updateLearningSettings(userId, LearningSettings(mode))
    // 로컬 캐시 업데이트
    cache.put("learning_mode_$userId", mode)
  }

  suspend fun getLearningMode(userId: String): String {
    // 캐시 우선 조회
    cache.get("learning_mode_$userId")?.let { return it }

    // 서버 조회
    val settings = api.getLearningSettings(userId)
    cache.put("learning_mode_$userId", settings.mode)
    return settings.mode
  }
}
```

---

### 4.3 북클럽 3.0 특화 설정

**공통 최상단 배치:**
- 모든 사용자 타입에서 동일하게 노출
- 북클럽 3.0의 핵심 차별화 기능

**포함 기능:**
1. **AI 독서 버디 노출 빈도**
   - 설정: 항상 / 필요할 때만 / 끄기
   - 기본값: 필요할 때만

2. **시선 추적 기반 시력 보호 알림**
   - 5분 간격 체크
   - 화면과의 거리/자세 교정 안내

3. **자동 재생**
   - 다음 콘텐츠 자동 시작
   - 기본값: OFF

---

## 5. 장애 및 보안 시나리오

### 5.1 네트워크 단절 시

**문제 상황:**
- 멤버십 메뉴(포인트 등) 진입 시 데이터 조회 불가

**대응 방안:**
```kotlin
try {
  val points = api.getPointsBalance()
  showPointsView(points)
} catch (e: NetworkException) {
  showOfflineMessage(
    "오프라인 상태입니다",
    "포인트 정보는 인터넷 연결 시 확인할 수 있어요."
  )
  // 진입 차단
  disablePointsMenu()
}
```

**UI 처리:**
```
┌─────────────────────────────────────┐
│ 💎 멤버십                           │
│                                     │
│   [📶 오프라인]                     │
│   포인트 통장 (회색 처리)            │
│   구매 내역 (회색 처리)              │
│                                     │
│   "인터넷 연결 후 다시 시도해주세요" │
└─────────────────────────────────────┘
```

---

### 5.2 계정 불일치

**시나리오:**
- Type 2 (개인 패드 정규 회원) 로그인
- Type 3으로 로그아웃

**처리 로직:**
```kotlin
fun onLogout() {
  // 1. 멤버십 캐시 즉시 삭제
  cache.clear("points_*")
  cache.clear("purchases_*")
  cache.clear("learning_settings_*")

  // 2. UI 즉시 리렌더링
  userType = UserType.TYPE3
  reloadSettings()

  // 3. 멤버십 메뉴 마스킹
  maskMembershipSection()
}
```

**보안 고려사항:**
- 민감 정보 (포인트, 구매내역) 메모리에서 완전 삭제
- 세션 토큰 무효화
- 로컬 DB 암호화 (AES-256)

---

### 5.3 비정상 접근 시도

**시나리오:**
- Type 3 사용자가 API 직접 호출하여 멤버십 정보 조회 시도

**서버 검증:**
```java
@GetMapping("/api/v1/points/balance")
public ResponseEntity<?> getPointsBalance(@AuthUser User user) {
  // 멤버십 활성화 체크
  if (!user.isMembershipActive()) {
    return ResponseEntity
      .status(HttpStatus.FORBIDDEN)
      .body(new ErrorResponse(
        "MEMBERSHIP_REQUIRED",
        "정규 회원만 이용 가능합니다."
      ));
  }

  return ResponseEntity.ok(pointsService.getBalance(user.getId()));
}
```

---

## 6. 구현 가이드

### 6.1 컴포넌트 구조

```
SettingsActivity
├─ TypeSimulator (Dev Only)
├─ SettingsHeader
├─ SettingsContent
│  ├─ Bookclub3Section (공통)
│  ├─ DeviceControlSection (Type 1만)
│  ├─ MembershipSection (Type 1, 2만)
│  │  └─ MaskOverlay (Type 3일 때)
│  ├─ LearningSection (Type 1, 2만)
│  │  └─ MaskOverlay (Type 3일 때)
│  ├─ AppSettingsSection (공통)
│  └─ AccountSection (공통)
└─ BottomButtons
   ├─ LogoutButton (공통)
   └─ ExitToLauncherButton (Type 1만)
```

---

### 6.2 구현 체크리스트

#### Phase 1: 기본 구조 (1주)
- [ ] 사용자 타입 판별 로직
- [ ] 3가지 타입별 화면 레이아웃
- [ ] 섹션별 조건부 렌더링

#### Phase 2: 기기 제어 (1주)
- [ ] 안드로이드 시스템 API 연동
- [ ] 밝기/음량 슬라이더
- [ ] 블루라이트 필터/Wi-Fi 토글

#### Phase 3: 멤버십 연동 (2주)
- [ ] 포인트 API 연동
- [ ] 구매 내역 조회
- [ ] 쿠폰 시스템
- [ ] 실시간 동기화

#### Phase 4: 학습 옵션 (1주)
- [ ] 학습 모드 설정
- [ ] KRS 엔진 연동
- [ ] 학습 리포트

#### Phase 5: 종료 UX (1주)
- [ ] 서비스 나가기 (Type 1)
- [ ] 로그아웃 처리
- [ ] 세션 관리

#### Phase 6: 마스킹 및 유도 (1주)
- [ ] Type 3 마스킹 UI
- [ ] 회원 전환 유도 팝업
- [ ] A/B 테스트 준비

---

### 6.3 테스트 시나리오

#### 기능 테스트
```
1. Type 1 → Type 2 전환
   - 기기 제어 섹션 숨김 확인
   - "서비스 나가기" 버튼 숨김 확인

2. Type 2 → Type 3 전환
   - 멤버십 섹션 마스킹 확인
   - 학습 옵션 마스킹 확인
   - 클릭 시 유도 팝업 확인

3. 네트워크 단절
   - 멤버십 메뉴 진입 차단
   - 오프라인 메시지 표시

4. 로그아웃
   - 캐시 삭제 확인
   - UI 즉시 업데이트 확인
```

#### 성능 테스트
- 타입 전환 시 리렌더링 시간 < 300ms
- API 응답 시간 < 500ms (p95)
- 메모리 사용량 < 100MB

---

## 📎 부록

### A. API 엔드포인트

```
# 멤버십
GET    /api/v1/points/balance
GET    /api/v1/purchases?days=30
GET    /api/v1/coupons
POST   /api/v1/coupons/register

# 학습 옵션
GET    /api/v1/learning/settings/:userId
PUT    /api/v1/learning/settings/:userId
GET    /api/v1/learning/report/:userId

# 계정
POST   /api/v1/auth/logout
GET    /api/v1/user/info
DELETE /api/v1/user/account
```

---

### B. 디자인 가이드

**웅진 브랜드 컬러:**
```css
/* Primary */
--woongjin-orange: #FF8C42;
--woongjin-yellow: #FFB84D;
--woongjin-gold: #FFC837;

/* Gradient */
--woongjin-gradient: linear-gradient(135deg, #FF8C42 0%, #FFB84D 50%, #FFC837 100%);

/* Background */
--bg-soft: #FFF8F0;
--bg-light: #FFF4E6;
```

**컴포넌트 스타일:**
- 섹션 카드: `border-radius: 16px`, `shadow: 0 2px 8px rgba(0,0,0,0.1)`
- 토글: 52x28px, 웅진 그라데이션 (ON)
- 슬라이더: Track 8px, Thumb 20px, 웅진 그라데이션

---

### C. 변경 이력

| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|----------|
| v1.0 | 2025-02-10 | Claude | 초안 작성 |

---

**문서 상태**: 🟢 Ready for Development
**다음 단계**: Phase 1 기본 구조 구현 착수
**예상 완료일**: 2025-03-10 (4주)
