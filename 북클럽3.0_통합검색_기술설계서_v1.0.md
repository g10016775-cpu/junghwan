# ë¶í´ëŸ½ 3.0 í†µí•©ê²€ìƒ‰ ì‹œìŠ¤í…œ ìƒì„¸ ê¸°ìˆ  ì„¤ê³„ì„œ

**ë¬¸ì„œ ë²„ì „**: v1.0
**ì‘ì„±ì¼**: 2025-02-10
**ëŒ€ìƒ ë…ì**: Backend ê°œë°œì, DevOps ì—”ì§€ë‹ˆì–´, QA ì—”ì§€ë‹ˆì–´
**ìƒíƒœ**: ğŸŸ¢ Ready for Development

---

## ğŸ“‹ ëª©ì°¨

1. [ê²€ìƒ‰ ë…¸ì¶œ ì •ì±… ìƒì„¸í™”](#1-ê²€ìƒ‰-ë…¸ì¶œ-ì •ì±…-ìƒì„¸í™”)
2. [BCMS ìŠ¤í‚¤ë§ˆ ì •ì˜](#2-bcms-ìŠ¤í‚¤ë§ˆ-ì •ì˜)
3. [PoC ê¸°ìˆ  ê²€ì¦ í¬ì¸íŠ¸](#3-poc-ê¸°ìˆ -ê²€ì¦-í¬ì¸íŠ¸)
4. [ì¥ì•  ëŒ€ì‘ ì‹œë‚˜ë¦¬ì˜¤](#4-ì¥ì• -ëŒ€ì‘-ì‹œë‚˜ë¦¬ì˜¤)
5. [êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸](#5-êµ¬í˜„-ì²´í¬ë¦¬ìŠ¤íŠ¸)

---

## 1. ê²€ìƒ‰ ë…¸ì¶œ ì •ì±… ìƒì„¸í™”

### 1.1 í•„ë“œ ì •ì˜ ë° ìš°ì„ ìˆœìœ„

#### BCMS DBì— ì¶”ê°€í•  í•„ë“œ

```sql
-- assets í…Œì´ë¸”ì— ì¶”ê°€í•  ì»¬ëŸ¼
ALTER TABLE assets ADD COLUMN search_visibility VARCHAR(20) DEFAULT 'auto';
  -- 'auto': ìë™ ê²°ì • (ê¸°ë³¸ê°’)
  -- 'force_show': ê°•ì œ ë…¸ì¶œ
  -- 'force_hide': ê°•ì œ ìˆ¨ê¹€

ALTER TABLE assets ADD COLUMN content_status VARCHAR(20) DEFAULT 'active';
  -- 'active': íŒë§¤ ì¤‘
  -- 'suspended': ì¼ì‹œ ì¤‘ì§€
  -- 'discontinued': ë‹¨ì¢…

ALTER TABLE assets ADD COLUMN service_target VARCHAR(50) DEFAULT 'all';
  -- 'all': ì „ì²´ íšŒì›
  -- 'premium': í”„ë¦¬ë¯¸ì—„ íšŒì›ë§Œ
  -- 'age_restricted': ì—°ë ¹ ì œí•œ (ë³„ë„ í•„ë“œ ì°¸ì¡°)

ALTER TABLE assets ADD COLUMN metadata_completeness INT DEFAULT 0;
  -- 0-100 ì ìˆ˜, ìë™ ê³„ì‚°
  -- ì œëª©(20), ì €ì(15), í‘œì§€(20), ì„¤ëª…(25), ISBN(10), ì¥ë¥´(10)

ALTER TABLE assets ADD COLUMN quality_score INT DEFAULT 100;
  -- 0-100 ì ìˆ˜, ì´ˆê¸°ê°’ 100
  -- ì‹ ê³  ì ‘ìˆ˜ ì‹œ ê°ì†Œ (-10/ê±´)

ALTER TABLE assets ADD COLUMN last_indexed_at TIMESTAMP NULL;
  -- ë§ˆì§€ë§‰ ì¸ë±ì‹± ì‹œê° (ëª¨ë‹ˆí„°ë§ìš©)
```

---

### 1.2 ê²€ìƒ‰ ë…¸ì¶œ ê²°ì • ë¡œì§ (Boolean Expression)

#### ìš°ì„ ìˆœìœ„ 1: ê°•ì œ ì œì–´ (Force Override)

```python
# ìµœìš°ì„  ì¡°ê±´ - ê´€ë¦¬ì ìˆ˜ë™ ì œì–´
if search_visibility == 'force_hide':
    return False  # ì ˆëŒ€ ë…¸ì¶œ ì•ˆ í•¨

if search_visibility == 'force_show':
    # ê°•ì œ ë…¸ì¶œì´ì§€ë§Œ, ë²•ì /ì •ì±…ì  ì°¨ë‹¨ì€ ë¬´ì‹œ ë¶ˆê°€
    if has_legal_issue or age_verification_required:
        return False
    return True  # ë¬´ì¡°ê±´ ë…¸ì¶œ
```

#### ìš°ì„ ìˆœìœ„ 2: ìë™ ê²°ì • (Auto)

```python
# search_visibility == 'auto'ì¸ ê²½ìš°
def is_searchable(asset):
    """
    ê²€ìƒ‰ ë…¸ì¶œ ì—¬ë¶€ ìë™ íŒë‹¨ í•¨ìˆ˜
    Returns: (bool, str) - (ë…¸ì¶œ ì—¬ë¶€, ì‚¬ìœ )
    """

    # 1. ê¸°ë³¸ í™œì„± ì¡°ê±´
    if asset.deleted_at is not None:
        return False, "soft_deleted"

    if asset.content_status != 'active':
        return False, f"status_{asset.content_status}"

    # 2. ë©”íƒ€ë°ì´í„° ì™„ì„±ë„
    if asset.metadata_completeness < 80:
        return False, f"metadata_incomplete_{asset.metadata_completeness}"

    # 3. í’ˆì§ˆ ì ìˆ˜
    if asset.quality_score < 60:
        return False, f"quality_low_{asset.quality_score}"

    # 4. ì €ì‘ê¶Œ ìƒíƒœ
    if asset.copyright_status != 'normal':
        return False, f"copyright_{asset.copyright_status}"

    # 5. ì‹¬ì˜ ë“±ê¸‰ í™•ì •
    if asset.rating is None or asset.rating == 'pending':
        return False, "rating_pending"

    # 6. ì„œë¹„ìŠ¤ íƒ€ê²Ÿ (íšŒì› ë“±ê¸‰)
    # â†’ ê²€ìƒ‰ ì‹œì ì— ìœ ì € ì •ë³´ì™€ ë§¤ì¹­í•˜ì—¬ í•„í„°ë§
    # ì—¬ê¸°ì„œëŠ” ë…¸ì¶œ ê°€ëŠ¥ ì—¬ë¶€ë§Œ íŒë‹¨
    if asset.service_target not in ['all', 'premium', 'age_restricted']:
        return False, f"invalid_target_{asset.service_target}"

    # ëª¨ë“  ì¡°ê±´ í†µê³¼
    return True, "auto_approved"
```

---

### 1.3 SQL ì¸ë±ì‹± ì¿¼ë¦¬ (Indexing Target)

```sql
-- OpenSearchì— ì¸ë±ì‹±í•  ìì¬ ì„ íƒ
SELECT
    a.asset_id,
    a.title,
    a.author,
    a.publisher,
    a.isbn,
    a.description,
    a.cover_image_url,
    a.krs_level,
    a.age_range_min,
    a.age_range_max,
    a.genre,
    a.series_name,
    a.media_type,
    a.publication_date,
    a.rating,
    a.content_status,
    a.service_target,
    a.metadata_completeness,
    a.quality_score,
    a.created_at,
    a.updated_at,

    -- ê²€ìƒ‰ ë…¸ì¶œ ì—¬ë¶€ ê³„ì‚° (DB ë ˆë²¨)
    CASE
        WHEN a.search_visibility = 'force_hide' THEN FALSE
        WHEN a.search_visibility = 'force_show'
             AND a.has_legal_issue = FALSE
             THEN TRUE
        WHEN a.search_visibility = 'auto'
             AND a.deleted_at IS NULL
             AND a.content_status = 'active'
             AND a.metadata_completeness >= 80
             AND a.quality_score >= 60
             AND a.copyright_status = 'normal'
             AND a.rating IS NOT NULL
             AND a.rating != 'pending'
             THEN TRUE
        ELSE FALSE
    END AS is_searchable

FROM assets a
WHERE a.deleted_at IS NULL
  AND (
      a.search_visibility = 'force_show'
      OR (
          a.search_visibility = 'auto'
          AND a.content_status = 'active'
          AND a.metadata_completeness >= 80
      )
  );
```

---

### 1.4 ê´€ë¦¬ì í˜ì´ì§€ UI ìŠ¤í™

#### ìì¬ ìƒì„¸ í˜ì´ì§€ - ê²€ìƒ‰ ë…¸ì¶œ ì„¤ì • ì„¹ì…˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” ê²€ìƒ‰ ë…¸ì¶œ ì„¤ì •                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚ ê²€ìƒ‰ ë…¸ì¶œ ëª¨ë“œ                              â”‚
â”‚ â—‰ ìë™ (ê¶Œì¥)                               â”‚
â”‚   í˜„ì¬ ìƒíƒœ: âœ… ë…¸ì¶œ ì¤‘                      â”‚
â”‚   ì‚¬ìœ : ëª¨ë“  ì¡°ê±´ ì¶©ì¡±                       â”‚
â”‚                                             â”‚
â”‚ â—‹ ê°•ì œ ë…¸ì¶œ                                 â”‚
â”‚   âš ï¸ ì •ì±… ìœ„ë°˜ ì‹œì—ë„ ë…¸ì¶œë©ë‹ˆë‹¤            â”‚
â”‚                                             â”‚
â”‚ â—‹ ê°•ì œ ìˆ¨ê¹€                                 â”‚
â”‚   í”„ë¡œëª¨ì…˜ ì¤€ë¹„ ë“± ì¼ì‹œì  ìˆ¨ê¹€ ì‹œ ì‚¬ìš©       â”‚
â”‚                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ğŸ“Š ìë™ ë…¸ì¶œ ì¡°ê±´ ì²´í¬                â”‚   â”‚
â”‚ â”‚                                       â”‚   â”‚
â”‚ â”‚ âœ… ë©”íƒ€ë°ì´í„° ì™„ì„±ë„: 95/100          â”‚   â”‚
â”‚ â”‚ âœ… í’ˆì§ˆ ì ìˆ˜: 100/100 (ì‹ ê³  0ê±´)      â”‚   â”‚
â”‚ â”‚ âœ… ì½˜í…ì¸  ìƒíƒœ: íŒë§¤ ì¤‘               â”‚   â”‚
â”‚ â”‚ âœ… ì €ì‘ê¶Œ: ì •ìƒ                       â”‚   â”‚
â”‚ â”‚ âœ… ì‹¬ì˜ ë“±ê¸‰: ì „ì²´ ì´ìš©ê°€             â”‚   â”‚
â”‚ â”‚                                       â”‚   â”‚
â”‚ â”‚ ì„œë¹„ìŠ¤ íƒ€ê²Ÿ: [ì „ì²´ íšŒì› â–¼]           â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚ ë§ˆì§€ë§‰ ì¸ë±ì‹±: 2025-02-10 14:32:15         â”‚
â”‚ [ğŸ”„ ì¦‰ì‹œ ì¬ì¸ë±ì‹±] [ğŸ’¾ ì €ì¥]               â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### API Endpoint

```http
PATCH /api/admin/assets/{asset_id}/search-visibility

Content-Type: application/json
Authorization: Bearer {admin_token}

{
  "search_visibility": "auto|force_show|force_hide",
  "service_target": "all|premium|age_restricted",
  "reason": "í”„ë¡œëª¨ì…˜ ì¤€ë¹„ ì¤‘" // ì„ íƒ ì‚¬í•­
}

Response 200 OK:
{
  "asset_id": "A123456",
  "search_visibility": "force_hide",
  "is_searchable": false,
  "updated_at": "2025-02-10T14:35:00Z",
  "updated_by": "admin@bookclub.com"
}
```

---

## 2. BCMS ìŠ¤í‚¤ë§ˆ ì •ì˜

### 2.1 OpenSearch ì¸ë±ìŠ¤ ë§¤í•‘ (Index Mapping)

```json
PUT /bookclub_assets_v1
{
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 2,
    "analysis": {
      "tokenizer": {
        "nori_user_dict": {
          "type": "nori_tokenizer",
          "decompound_mode": "mixed",
          "user_dictionary": "userdict_ko.txt"
        },
        "ngram_tokenizer": {
          "type": "ngram",
          "min_gram": 2,
          "max_gram": 3,
          "token_chars": ["letter", "digit"]
        },
        "chosung_tokenizer": {
          "type": "pattern",
          "pattern": "[^ã„±-ã…]"
        }
      },
      "analyzer": {
        "nori_analyzer": {
          "type": "custom",
          "tokenizer": "nori_user_dict",
          "filter": ["lowercase", "nori_readingform"]
        },
        "ngram_analyzer": {
          "type": "custom",
          "tokenizer": "ngram_tokenizer",
          "filter": ["lowercase"]
        },
        "chosung_analyzer": {
          "type": "custom",
          "tokenizer": "chosung_tokenizer",
          "filter": ["lowercase"]
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "asset_id": {
        "type": "keyword"
      },
      "title": {
        "type": "text",
        "analyzer": "nori_analyzer",
        "fields": {
          "ngram": {
            "type": "text",
            "analyzer": "ngram_analyzer"
          },
          "chosung": {
            "type": "text",
            "analyzer": "chosung_analyzer"
          },
          "keyword": {
            "type": "keyword"
          }
        }
      },
      "author": {
        "type": "text",
        "analyzer": "nori_analyzer",
        "fields": {
          "keyword": {
            "type": "keyword"
          }
        }
      },
      "publisher": {
        "type": "keyword"
      },
      "isbn": {
        "type": "keyword"
      },
      "description": {
        "type": "text",
        "analyzer": "nori_analyzer"
      },
      "cover_image_url": {
        "type": "keyword",
        "index": false
      },
      "krs_level": {
        "type": "integer"
      },
      "age_range_min": {
        "type": "integer"
      },
      "age_range_max": {
        "type": "integer"
      },
      "genre": {
        "type": "keyword"
      },
      "series_name": {
        "type": "keyword"
      },
      "media_type": {
        "type": "keyword"
      },
      "rating": {
        "type": "keyword"
      },
      "content_status": {
        "type": "keyword"
      },
      "service_target": {
        "type": "keyword"
      },
      "is_searchable": {
        "type": "boolean"
      },
      "metadata_completeness": {
        "type": "integer"
      },
      "quality_score": {
        "type": "integer"
      },
      "popularity_score": {
        "type": "float"
      },
      "publication_date": {
        "type": "date"
      },
      "created_at": {
        "type": "date"
      },
      "updated_at": {
        "type": "date"
      },
      "indexed_at": {
        "type": "date"
      },

      "ai_tags": {
        "type": "keyword"
      },
      "user_review_keywords": {
        "type": "text",
        "analyzer": "nori_analyzer"
      },
      "ocr_text": {
        "type": "text",
        "analyzer": "nori_analyzer"
      }
    }
  }
}
```

---

### 2.2 BCMS â†’ OpenSearch ë°ì´í„° í˜ì´ë¡œë“œ

#### Kafka ë©”ì‹œì§€ í¬ë§·

```json
// Topic: bookclub.assets.changes
{
  "schema": {
    "type": "struct",
    "name": "bookclub.assets.Envelope",
    "version": 1
  },
  "payload": {
    "before": null, // UPDATE ì‹œì—ëŠ” ì´ì „ ê°’
    "after": {
      "asset_id": "A123456",
      "title": "ì‹ ë¹„ì•„íŒŒíŠ¸ ê³ ìŠ¤íŠ¸ë³¼ Xì˜ íƒ„ìƒ",
      "author": "ì„œìš¸ë¬¸í™”ì‚¬ í¸ì§‘ë¶€",
      "publisher": "ì„œìš¸ë¬¸í™”ì‚¬",
      "isbn": "9788926377123",
      "description": "ì‹ ë¹„ì•„íŒŒíŠ¸ ì‹œë¦¬ì¦ˆì˜ ìƒˆë¡œìš´ ëª¨í—˜! ê³ ìŠ¤íŠ¸ë³¼...",
      "cover_image_url": "https://cdn.bookclub.com/covers/A123456.jpg",
      "krs_level": 3,
      "age_range_min": 7,
      "age_range_max": 10,
      "genre": "ë§Œí™”",
      "series_name": "ì‹ ë¹„ì•„íŒŒíŠ¸",
      "media_type": "book",
      "rating": "all",
      "content_status": "active",
      "service_target": "all",
      "search_visibility": "auto",
      "metadata_completeness": 95,
      "quality_score": 100,
      "copyright_status": "normal",
      "publication_date": "2024-12-15T00:00:00Z",
      "created_at": "2024-12-10T09:23:15Z",
      "updated_at": "2025-02-10T14:35:22Z",
      "deleted_at": null
    },
    "op": "u", // c=create, u=update, d=delete
    "ts_ms": 1707565522000,
    "source": {
      "version": "2.0.0",
      "connector": "mysql",
      "name": "bookclub-bcms",
      "db": "bookclub_production",
      "table": "assets"
    }
  }
}
```

---

#### OpenSearch Bulk Indexing í˜ì´ë¡œë“œ

```json
// POST /_bulk
{ "index": { "_index": "bookclub_assets_v1", "_id": "A123456" } }
{
  "asset_id": "A123456",
  "title": "ì‹ ë¹„ì•„íŒŒíŠ¸ ê³ ìŠ¤íŠ¸ë³¼ Xì˜ íƒ„ìƒ",
  "author": "ì„œìš¸ë¬¸í™”ì‚¬ í¸ì§‘ë¶€",
  "publisher": "ì„œìš¸ë¬¸í™”ì‚¬",
  "isbn": "9788926377123",
  "description": "ì‹ ë¹„ì•„íŒŒíŠ¸ ì‹œë¦¬ì¦ˆì˜ ìƒˆë¡œìš´ ëª¨í—˜! ê³ ìŠ¤íŠ¸ë³¼...",
  "cover_image_url": "https://cdn.bookclub.com/covers/A123456.jpg",
  "krs_level": 3,
  "age_range_min": 7,
  "age_range_max": 10,
  "genre": "ë§Œí™”",
  "series_name": "ì‹ ë¹„ì•„íŒŒíŠ¸",
  "media_type": "book",
  "rating": "all",
  "content_status": "active",
  "service_target": "all",
  "is_searchable": true,
  "metadata_completeness": 95,
  "quality_score": 100,
  "popularity_score": 87.5,
  "publication_date": "2024-12-15",
  "created_at": "2024-12-10T09:23:15Z",
  "updated_at": "2025-02-10T14:35:22Z",
  "indexed_at": "2025-02-10T14:35:25Z",

  "ai_tags": ["ëª¨í—˜", "ìš°ì •", "ê·€ì‹ ", "íŒíƒ€ì§€"],
  "user_review_keywords": "ì¬ë¯¸ìˆì–´ìš” ì•„ì´ê°€ ì¢‹ì•„í•´ìš” ì‹œë¦¬ì¦ˆ ë‹¤ìŒí¸ ê¸°ëŒ€",
  "ocr_text": null
}
```

---

### 2.3 Indexer Service êµ¬í˜„ ì˜ˆì‹œ (Python)

```python
# indexer_service.py
from kafka import KafkaConsumer
from opensearchpy import OpenSearch, helpers
import json
from datetime import datetime

class AssetIndexer:
    def __init__(self):
        self.es_client = OpenSearch(
            hosts=[{'host': 'opensearch.internal', 'port': 9200}],
            http_auth=('admin', 'password'),
            use_ssl=True,
            verify_certs=True
        )

        self.consumer = KafkaConsumer(
            'bookclub.assets.changes',
            bootstrap_servers=['kafka:9092'],
            value_deserializer=lambda m: json.loads(m.decode('utf-8')),
            group_id='opensearch-indexer',
            auto_offset_reset='earliest',
            enable_auto_commit=False
        )

    def process_message(self, msg):
        """Kafka ë©”ì‹œì§€ ì²˜ë¦¬"""
        payload = msg.value['payload']
        op = payload['op']
        after = payload['after']

        if op == 'd':  # DELETE
            return self.delete_document(after['asset_id'])

        # CREATE or UPDATE
        if not self.should_index(after):
            # ë…¸ì¶œ ì¡°ê±´ ë¯¸ë‹¬ â†’ ì¸ë±ìŠ¤ì—ì„œ ì œê±°
            return self.delete_document(after['asset_id'])

        doc = self.transform_to_document(after)
        return self.index_document(doc)

    def should_index(self, asset_data):
        """ê²€ìƒ‰ ë…¸ì¶œ ì—¬ë¶€ íŒë‹¨"""
        if asset_data.get('deleted_at'):
            return False

        if asset_data['search_visibility'] == 'force_hide':
            return False

        if asset_data['search_visibility'] == 'force_show':
            return not asset_data.get('has_legal_issue', False)

        # auto ëª¨ë“œ
        return (
            asset_data['content_status'] == 'active' and
            asset_data['metadata_completeness'] >= 80 and
            asset_data['quality_score'] >= 60 and
            asset_data['copyright_status'] == 'normal' and
            asset_data['rating'] not in [None, 'pending']
        )

    def transform_to_document(self, asset_data):
        """BCMS ë°ì´í„° â†’ OpenSearch ë¬¸ì„œ ë³€í™˜"""
        return {
            '_index': 'bookclub_assets_v1',
            '_id': asset_data['asset_id'],
            '_source': {
                'asset_id': asset_data['asset_id'],
                'title': asset_data['title'],
                'author': asset_data['author'],
                'publisher': asset_data.get('publisher'),
                'isbn': asset_data.get('isbn'),
                'description': asset_data.get('description', ''),
                'cover_image_url': asset_data.get('cover_image_url'),
                'krs_level': asset_data.get('krs_level'),
                'age_range_min': asset_data.get('age_range_min'),
                'age_range_max': asset_data.get('age_range_max'),
                'genre': asset_data.get('genre'),
                'series_name': asset_data.get('series_name'),
                'media_type': asset_data.get('media_type', 'book'),
                'rating': asset_data.get('rating'),
                'content_status': asset_data['content_status'],
                'service_target': asset_data.get('service_target', 'all'),
                'is_searchable': True,
                'metadata_completeness': asset_data['metadata_completeness'],
                'quality_score': asset_data['quality_score'],
                'publication_date': asset_data.get('publication_date'),
                'created_at': asset_data['created_at'],
                'updated_at': asset_data['updated_at'],
                'indexed_at': datetime.utcnow().isoformat() + 'Z'
            }
        }

    def index_document(self, doc):
        """ë¬¸ì„œ ì¸ë±ì‹±"""
        try:
            response = self.es_client.index(
                index=doc['_index'],
                id=doc['_id'],
                body=doc['_source']
            )
            return {'success': True, 'response': response}
        except Exception as e:
            return {'success': False, 'error': str(e)}

    def delete_document(self, asset_id):
        """ë¬¸ì„œ ì‚­ì œ"""
        try:
            response = self.es_client.delete(
                index='bookclub_assets_v1',
                id=asset_id,
                ignore=[404]  # ì—†ì–´ë„ ì—ëŸ¬ ì•ˆ ë‚¨
            )
            return {'success': True, 'response': response}
        except Exception as e:
            return {'success': False, 'error': str(e)}

    def run(self):
        """ë©”ì¸ ë£¨í”„"""
        for msg in self.consumer:
            try:
                result = self.process_message(msg)
                if result['success']:
                    self.consumer.commit()
                else:
                    # ì—ëŸ¬ ë¡œê¹… & DLQ ì „ì†¡
                    self.send_to_dlq(msg, result['error'])
            except Exception as e:
                print(f"Error processing message: {e}")
                # ì¬ì‹œë„ ë¡œì§ (ë‹¤ìŒ ì„¹ì…˜ ì°¸ì¡°)
```

---

## 3. PoC ê¸°ìˆ  ê²€ì¦ í¬ì¸íŠ¸

### 3.1 ì´ˆì„± ê²€ìƒ‰ + ë¶€ë¶„ ì¼ì¹˜ ì •í™•ë„ í…ŒìŠ¤íŠ¸

#### í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¤€ë¹„

```json
// í…ŒìŠ¤íŠ¸ìš© ìƒ˜í”Œ ë°ì´í„°
POST /_bulk
{ "index": { "_index": "bookclub_assets_v1", "_id": "1" } }
{ "title": "ì‹ ë¹„ì•„íŒŒíŠ¸", "krs_level": 3 }
{ "index": { "_index": "bookclub_assets_v1", "_id": "2" } }
{ "title": "ì‹ ë¹„í•œ ë§ˆë²•ì˜ ì„±", "krs_level": 3 }
{ "index": { "_index": "bookclub_assets_v1", "_id": "3" } }
{ "title": "ì‹¬ì¿µ ë°”ë‹¤ ì—¬í–‰", "krs_level": 2 }
{ "index": { "_index": "bookclub_assets_v1", "_id": "4" } }
{ "title": "ë˜ë´‡", "krs_level": 3 }
{ "index": { "_index": "bookclub_assets_v1", "_id": "5" } }
{ "title": "íƒ€ìš” ë²„ìŠ¤", "krs_level": 2 }
```

---

#### Test Case 1: ì´ˆì„± ê²€ìƒ‰

```json
// ì¿¼ë¦¬: "ã……ã…‚ã…‡ã…ã…Œ" â†’ "ì‹ ë¹„ì•„íŒŒíŠ¸" ì°¾ê¸°
POST /bookclub_assets_v1/_search
{
  "query": {
    "bool": {
      "should": [
        {
          "match": {
            "title.chosung": {
              "query": "ã……ã…‚ã…‡ã…ã…Œ",
              "boost": 2.0
            }
          }
        },
        {
          "match": {
            "title": {
              "query": "ã……ã…‚ã…‡ã…ã…Œ",
              "fuzziness": "AUTO"
            }
          }
        }
      ],
      "minimum_should_match": 1
    }
  }
}

// ê¸°ëŒ€ ê²°ê³¼:
// 1ìœ„: "ì‹ ë¹„ì•„íŒŒíŠ¸" (ì´ˆì„± ì •í™• ë§¤ì¹­)
// 2ìœ„: "ì‹ ë¹„í•œ ë§ˆë²•ì˜ ì„±" (ë¶€ë¶„ ë§¤ì¹­)
```

**ê²€ì¦ ê¸°ì¤€:**
- âœ… "ì‹ ë¹„ì•„íŒŒíŠ¸"ê°€ 1ìœ„
- âœ… Score > 2.0 (boost ì ìš© í™•ì¸)
- âœ… ì‘ë‹µ ì‹œê°„ < 50ms

---

#### Test Case 2: ì˜¤íƒ€ êµì • (Fuzzy Matching)

```json
// ì¿¼ë¦¬: "ì‹ ë¹„ì•„íŒŒëœ¨" â†’ "ì‹ ë¹„ì•„íŒŒíŠ¸"
POST /bookclub_assets_v1/_search
{
  "query": {
    "multi_match": {
      "query": "ì‹ ë¹„ì•„íŒŒëœ¨",
      "fields": ["title^3", "title.ngram"],
      "fuzziness": "AUTO",
      "prefix_length": 1
    }
  },
  "suggest": {
    "title_suggestion": {
      "text": "ì‹ ë¹„ì•„íŒŒëœ¨",
      "term": {
        "field": "title",
        "suggest_mode": "popular"
      }
    }
  }
}

// ê¸°ëŒ€ ê²°ê³¼:
// 1ìœ„: "ì‹ ë¹„ì•„íŒŒíŠ¸" (Edit Distance 1)
// suggest: "ì‹ ë¹„ì•„íŒŒíŠ¸"
```

**ê²€ì¦ ê¸°ì¤€:**
- âœ… "ì‹ ë¹„ì•„íŒŒíŠ¸" ê²€ìƒ‰ ì„±ê³µ
- âœ… Suggestionì— "ì‹ ë¹„ì•„íŒŒíŠ¸" í¬í•¨
- âœ… Edit Distance 2ê¹Œì§€ í—ˆìš©

---

#### Test Case 3: ë¶€ë¶„ ì¼ì¹˜ (Ngram)

```json
// ì¿¼ë¦¬: "ì•„íŒŒ" â†’ "ì‹ ë¹„ì•„íŒŒíŠ¸", "ì‹ ë¹„í•œ ë§ˆë²•ì˜ ì„±"
POST /bookclub_assets_v1/_search
{
  "query": {
    "bool": {
      "should": [
        {
          "match": {
            "title": {
              "query": "ì•„íŒŒ",
              "boost": 3.0
            }
          }
        },
        {
          "match": {
            "title.ngram": {
              "query": "ì•„íŒŒ",
              "boost": 1.5
            }
          }
        }
      ]
    }
  }
}

// ê¸°ëŒ€ ê²°ê³¼:
// 1ìœ„: "ì‹ ë¹„ì•„íŒŒíŠ¸" ("ì•„íŒŒ" ë¶€ë¶„ ë§¤ì¹­)
```

**ê²€ì¦ ê¸°ì¤€:**
- âœ… "ì‹ ë¹„ì•„íŒŒíŠ¸"ê°€ ê²°ê³¼ì— í¬í•¨
- âœ… 2ê¸€ì ë¶€ë¶„ ê²€ìƒ‰ ì‘ë™
- âœ… ê³¼ë„í•œ ê²°ê³¼ ì—†ìŒ (precision)

---

### 3.2 KRS ë ˆë²¨ ë¶€ìŠ¤íŒ… ê²€ì¦ ì‹œë‚˜ë¦¬ì˜¤

#### í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

```
ì‚¬ìš©ì: 8ì„¸ ì•„ë™, KRS ë ˆë²¨ 3
ê²€ìƒ‰ì–´: "ëª¨í—˜"
```

#### í…ŒìŠ¤íŠ¸ ë°ì´í„°

```json
POST /_bulk
{ "index": { "_index": "bookclub_assets_v1", "_id": "K1" } }
{ "title": "ëª¨í—˜ì™• íƒí—˜ëŒ€", "krs_level": 3, "popularity_score": 70 }
{ "index": { "_index": "bookclub_assets_v1", "_id": "K2" } }
{ "title": "ìˆ²ì† ëª¨í—˜", "krs_level": 2, "popularity_score": 85 }
{ "index": { "_index": "bookclub_assets_v1", "_id": "K3" } }
{ "title": "ìš°ì£¼ ëª¨í—˜", "krs_level": 5, "popularity_score": 90 }
{ "index": { "_index": "bookclub_assets_v1", "_id": "K4" } }
{ "title": "ëª¨í—˜ ì¼ê¸°", "krs_level": 3, "popularity_score": 60 }
```

---

#### ê²€ì¦ ì¿¼ë¦¬ 1: ì •í™• ë§¤ì¹­ (KRS=3) 2ë°° ë¶€ìŠ¤íŒ…

```json
POST /bookclub_assets_v1/_search
{
  "query": {
    "function_score": {
      "query": {
        "match": {
          "title": "ëª¨í—˜"
        }
      },
      "functions": [
        {
          "filter": {
            "term": {
              "krs_level": 3  // ì‚¬ìš©ì ë ˆë²¨
            }
          },
          "weight": 2.0
        },
        {
          "filter": {
            "range": {
              "krs_level": {
                "gte": 2,  // user_krs - 1
                "lte": 4   // user_krs + 1
              }
            }
          },
          "weight": 1.5
        },
        {
          "field_value_factor": {
            "field": "popularity_score",
            "factor": 0.01,
            "modifier": "sqrt"
          }
        }
      ],
      "score_mode": "multiply",
      "boost_mode": "multiply"
    }
  },
  "explain": true  // ìŠ¤ì½”ì–´ ê³„ì‚° ê³¼ì • í™•ì¸
}

// ê¸°ëŒ€ ê²°ê³¼ ìˆœì„œ:
// 1ìœ„: K1 "ëª¨í—˜ì™• íƒí—˜ëŒ€" (KRS=3, 2.0x boost)
// 2ìœ„: K4 "ëª¨í—˜ ì¼ê¸°" (KRS=3, 2.0x boost, ì¸ê¸°ë„ ë‚®ìŒ)
// 3ìœ„: K2 "ìˆ²ì† ëª¨í—˜" (KRS=2, 1.5x boost, ì¸ê¸°ë„ ë†’ìŒ)
// 4ìœ„: K3 "ìš°ì£¼ ëª¨í—˜" (KRS=5, boost ì—†ìŒ, ì¸ê¸°ë„ ìµœê³ )
```

---

#### ê²€ì¦ ê¸°ì¤€ (Assertion)

```python
def test_krs_boosting():
    response = search_with_krs_boost(user_krs=3, query="ëª¨í—˜")
    hits = response['hits']['hits']

    # 1. KRS ì •í™• ë§¤ì¹­ ìë£Œê°€ ìƒìœ„ ë…¸ì¶œ
    assert hits[0]['_source']['krs_level'] == 3
    assert hits[1]['_source']['krs_level'] == 3

    # 2. ìŠ¤ì½”ì–´ê°€ 2ë°° ì´ìƒ ì°¨ì´
    score_krs_3 = hits[0]['_score']
    score_krs_5 = hits[3]['_score']
    assert score_krs_3 / score_krs_5 >= 2.0

    # 3. Â±1 ë ˆë²¨ì€ 1.5ë°° ë¶€ìŠ¤íŒ…
    score_krs_2 = hits[2]['_score']
    score_base = get_base_score(query="ëª¨í—˜")
    assert score_krs_2 / score_base >= 1.5

    print("âœ… KRS ë¶€ìŠ¤íŒ… ê²€ì¦ í†µê³¼")
```

---

#### ê²€ì¦ ì¿¼ë¦¬ 2: ì‚¬ìš©ì ë§ì¶¤ í•„í„° ON/OFF ë¹„êµ

```json
// í•„í„° ON: KRS Â±1 ë²”ìœ„ë§Œ ë…¸ì¶œ
POST /bookclub_assets_v1/_search
{
  "query": {
    "bool": {
      "must": {
        "match": { "title": "ëª¨í—˜" }
      },
      "filter": {
        "range": {
          "krs_level": {
            "gte": 2,
            "lte": 4
          }
        }
      }
    }
  }
}
// ê²°ê³¼: K1, K2, K4ë§Œ (K3 ì œì™¸ë¨)

// í•„í„° OFF: ì „ì²´ ë…¸ì¶œ
POST /bookclub_assets_v1/_search
{
  "query": {
    "match": { "title": "ëª¨í—˜" }
  }
}
// ê²°ê³¼: K1, K2, K3, K4 ëª¨ë‘
```

**ê²€ì¦ ê¸°ì¤€:**
- âœ… í•„í„° ON ì‹œ ë¶€ì í•© ë ˆë²¨ ì œì™¸
- âœ… í•„í„° OFF ì‹œ ì „ì²´ ë…¸ì¶œ
- âœ… UI í† ê¸€ ë™ì‘ ì •ìƒ

---

### 3.3 ìë™ì™„ì„± (Autocomplete) ì„±ëŠ¥ í…ŒìŠ¤íŠ¸

```json
// Completion Suggester ì‚¬ìš©
PUT /bookclub_assets_v1
{
  "mappings": {
    "properties": {
      "title_suggest": {
        "type": "completion",
        "analyzer": "nori_analyzer",
        "contexts": [
          {
            "name": "krs_level",
            "type": "category"
          }
        ]
      }
    }
  }
}

// ìë™ì™„ì„± ì¿¼ë¦¬
POST /bookclub_assets_v1/_search
{
  "suggest": {
    "title_autocomplete": {
      "prefix": "ì‹ ë¹„",
      "completion": {
        "field": "title_suggest",
        "size": 5,
        "contexts": {
          "krs_level": [2, 3, 4]  // ì‚¬ìš©ì ë ˆë²¨ Â±1
        }
      }
    }
  }
}

// ê¸°ëŒ€ ê²°ê³¼:
// "ì‹ ë¹„ì•„íŒŒíŠ¸"
// "ì‹ ë¹„í•œ ë§ˆë²•ì˜ ì„±"
```

**ì„±ëŠ¥ ëª©í‘œ:**
- âœ… ì‘ë‹µ ì‹œê°„ < 50ms (p95)
- âœ… ì´ˆì„± ì…ë ¥ í›„ 2ê¸€ìë¶€í„° ì¶”ì²œ
- âœ… ì‚¬ìš©ì ë ˆë²¨ ê¸°ë°˜ í•„í„°ë§

---

## 4. ì¥ì•  ëŒ€ì‘ ì‹œë‚˜ë¦¬ì˜¤

### 4.1 ì¸ë±ì‹± ì§€ì—° ë°œìƒ ì‹œë‚˜ë¦¬ì˜¤

#### ì‹œë‚˜ë¦¬ì˜¤ A: Kafka ì»¨ìŠˆë¨¸ ì—ëŸ¬

**ì¦ìƒ:**
- Indexer ì„œë¹„ìŠ¤ê°€ ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸ ë°œìƒ
- íŠ¹ì • ìì¬ ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜ (ì˜ˆ: null í•„ë“œ)

**ì¬ì‹œë„ ì „ëµ:**

```python
from tenacity import retry, stop_after_attempt, wait_exponential
import logging

class ResilientIndexer(AssetIndexer):

    @retry(
        stop=stop_after_attempt(3),
        wait=wait_exponential(multiplier=1, min=1, max=60),
        reraise=True
    )
    def process_message_with_retry(self, msg):
        """ì¬ì‹œë„ ë¡œì§ì´ í¬í•¨ëœ ë©”ì‹œì§€ ì²˜ë¦¬"""
        try:
            return self.process_message(msg)
        except ValidationError as e:
            # ë°ì´í„° ì˜¤ë¥˜ â†’ ì¬ì‹œë„ ë¶ˆí•„ìš”, DLQ ì§í–‰
            logging.error(f"Validation error: {e}")
            self.send_to_dlq(msg, error=str(e))
            raise
        except (NetworkError, TimeoutError) as e:
            # ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ â†’ ì¬ì‹œë„
            logging.warning(f"Retryable error: {e}")
            raise

    def send_to_dlq(self, msg, error):
        """Dead Letter Queueë¡œ ì „ì†¡"""
        dlq_producer = KafkaProducer(
            bootstrap_servers=['kafka:9092'],
            value_serializer=lambda v: json.dumps(v).encode('utf-8')
        )

        dlq_message = {
            'original_message': msg.value,
            'error': error,
            'timestamp': datetime.utcnow().isoformat(),
            'retry_count': msg.headers.get('retry_count', 0)
        }

        dlq_producer.send('bookclub.assets.dlq', value=dlq_message)

        # Slack ì•Œë¦¼
        self.notify_slack(
            channel='#search-alerts',
            message=f"ğŸ”´ DLQ ì „ì†¡: {msg.value['payload']['after']['asset_id']}\nì—ëŸ¬: {error}"
        )
```

---

#### ì¬ì‹œë„ ì •ì±… í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Kafka Message   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Process Message â”‚â”€â”€â” ì„±ê³µ â†’ Commit
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
         â”‚ ì‹¤íŒ¨      â”‚
         â–¼           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ Retry #1 (1ì´ˆ)  â”‚â”€â”€â”¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
         â”‚ ì‹¤íŒ¨      â”‚
         â–¼           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ Retry #2 (5ì´ˆ)  â”‚â”€â”€â”¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
         â”‚ ì‹¤íŒ¨      â”‚
         â–¼           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ Retry #3 (15ì´ˆ) â”‚â”€â”€â”¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
         â”‚ ì‹¤íŒ¨      â”‚
         â–¼           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  Send to DLQ    â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
         â”‚           â”‚
         â–¼           â–¼
   Slack Alert   âœ… Success
```

---

#### DLQ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”´ Dead Letter Queue ê´€ë¦¬                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ì´ ì‹¤íŒ¨ ë©”ì‹œì§€: 3ê±´                          â”‚
â”‚                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Asset ID: A123456                   â”‚   â”‚
â”‚ â”‚ ì˜¤ë¥˜: KeyError: 'krs_level'         â”‚   â”‚
â”‚ â”‚ ë°œìƒ ì‹œê°: 2025-02-10 15:23:11      â”‚   â”‚
â”‚ â”‚ ì¬ì‹œë„ íšŸìˆ˜: 3/3                    â”‚   â”‚
â”‚ â”‚                                     â”‚   â”‚
â”‚ â”‚ [ğŸ“„ ì›ë³¸ ë³´ê¸°] [ğŸ”„ ì¬ì²˜ë¦¬] [ğŸ—‘ï¸ ì‚­ì œ] â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Asset ID: B789012                   â”‚   â”‚
â”‚ â”‚ ì˜¤ë¥˜: Timeout connecting to ES      â”‚   â”‚
â”‚ â”‚ ë°œìƒ ì‹œê°: 2025-02-10 14:55:33      â”‚   â”‚
â”‚ â”‚                                     â”‚   â”‚
â”‚ â”‚ [ğŸ”„ ì¬ì²˜ë¦¬] [ğŸ—‘ï¸ ì‚­ì œ]                â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚ [ğŸ”„ ì „ì²´ ì¬ì²˜ë¦¬] [ğŸ“Š í†µê³„ ë³´ê¸°]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 4.2 ê²€ìƒ‰ ì—”ì§„ ë‹¤ìš´ ì‹œ Circuit Breaker

#### Hystrix íŒ¨í„´ êµ¬í˜„

```python
from pybreaker import CircuitBreaker, CircuitBreakerError
from functools import wraps
import redis

# Circuit Breaker ì„¤ì •
search_breaker = CircuitBreaker(
    fail_max=5,           # 5íšŒ ì—°ì† ì‹¤íŒ¨ ì‹œ Open
    timeout_duration=60,  # 60ì´ˆ í›„ Half-Open
    exclude=[ValidationError]  # ì´ ì˜ˆì™¸ëŠ” ì¹´ìš´íŠ¸ ì•ˆ í•¨
)

class SearchService:
    def __init__(self):
        self.es_client = OpenSearch(...)
        self.redis_client = redis.Redis(host='redis', port=6379)
        self.db_fallback = DatabaseFallback()

    @search_breaker
    def search_opensearch(self, query, user_krs):
        """OpenSearch ê²€ìƒ‰ (Circuit Breaker ë³´í˜¸)"""
        try:
            response = self.es_client.search(
                index='bookclub_assets_v1',
                body=self.build_query(query, user_krs),
                timeout='500ms'
            )
            return self.format_results(response)
        except Exception as e:
            logging.error(f"OpenSearch error: {e}")
            raise  # Circuit Breakerê°€ ì¹´ìš´íŠ¸

    def search_with_fallback(self, query, user_krs):
        """Fallbackì´ í¬í•¨ëœ ê²€ìƒ‰"""
        try:
            # 1ì°¨ ì‹œë„: OpenSearch
            return self.search_opensearch(query, user_krs)

        except CircuitBreakerError:
            # Circuit Breaker Open ìƒíƒœ
            logging.warning("Circuit breaker is OPEN, using fallback")
            return self.search_fallback(query, user_krs)

        except Exception as e:
            # ê¸°íƒ€ ì˜ˆì™¸
            logging.error(f"Unexpected error: {e}")
            return self.search_fallback(query, user_krs)

    def search_fallback(self, query, user_krs):
        """Fallback: Redis Cache â†’ DB"""
        # 1. Redis ìºì‹œ í™•ì¸
        cache_key = f"search:{query}:{user_krs}"
        cached = self.redis_client.get(cache_key)
        if cached:
            logging.info("Serving from Redis cache")
            return json.loads(cached)

        # 2. DB ì§ì ‘ ê²€ìƒ‰ (ìµœì†Œ ê¸°ëŠ¥)
        logging.warning("OpenSearch down, using DB fallback")
        results = self.db_fallback.simple_search(query, user_krs)

        # ìºì‹œ ì €ì¥ (5ë¶„)
        self.redis_client.setex(
            cache_key,
            300,
            json.dumps(results)
        )

        return results
```

---

#### Database Fallback (ìµœì†Œ ê²€ìƒ‰)

```python
class DatabaseFallback:
    def __init__(self):
        self.db = get_db_connection()

    def simple_search(self, query, user_krs):
        """DB ê¸°ë°˜ ê°„ë‹¨í•œ ê²€ìƒ‰ (ì„±ëŠ¥ ë‚®ìŒ)"""
        # LIKE ê²€ìƒ‰ (ëŠë¦¬ì§€ë§Œ ë™ì‘ì€ í•¨)
        sql = """
            SELECT
                asset_id,
                title,
                author,
                cover_image_url,
                krs_level
            FROM assets
            WHERE deleted_at IS NULL
              AND content_status = 'active'
              AND is_searchable = TRUE
              AND (
                  title LIKE %s
                  OR author LIKE %s
              )
              AND krs_level BETWEEN %s AND %s
            ORDER BY
              CASE WHEN krs_level = %s THEN 1 ELSE 2 END,
              updated_at DESC
            LIMIT 20
        """

        search_pattern = f"%{query}%"
        krs_min = max(1, user_krs - 1)
        krs_max = user_krs + 1

        with self.db.cursor() as cursor:
            cursor.execute(
                sql,
                (search_pattern, search_pattern, krs_min, krs_max, user_krs)
            )
            rows = cursor.fetchall()

        return {
            'hits': [
                {
                    'asset_id': row['asset_id'],
                    'title': row['title'],
                    'author': row['author'],
                    'cover_image_url': row['cover_image_url'],
                    'krs_level': row['krs_level']
                }
                for row in rows
            ],
            'total': len(rows),
            'fallback': True,  # UIì— ì•Œë¦¼ í‘œì‹œìš©
            'message': 'ê²€ìƒ‰ ì‹œìŠ¤í…œ ì ê²€ ì¤‘ì…ë‹ˆë‹¤. ì œí•œëœ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.'
        }
```

---

#### Circuit Breaker ìƒíƒœ ëª¨ë‹ˆí„°ë§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”Œ Circuit Breaker ìƒíƒœ                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚ OpenSearch Circuit:  ğŸŸ¢ CLOSED             â”‚
â”‚ ì—°ì† ì‹¤íŒ¨ íšŸìˆ˜: 0 / 5                        â”‚
â”‚ ë§ˆì§€ë§‰ ìš”ì²­: 2025-02-10 15:45:22 (ì„±ê³µ)    â”‚
â”‚                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ìµœê·¼ 1ì‹œê°„ í†µê³„                      â”‚   â”‚
â”‚ â”‚                                     â”‚   â”‚
â”‚ â”‚ ì´ ìš”ì²­: 1,234ê±´                    â”‚   â”‚
â”‚ â”‚ ì„±ê³µ: 1,230ê±´ (99.7%)               â”‚   â”‚
â”‚ â”‚ ì‹¤íŒ¨: 4ê±´ (0.3%)                    â”‚   â”‚
â”‚ â”‚ Fallback ì‚¬ìš©: 0ê±´                  â”‚   â”‚
â”‚ â”‚                                     â”‚   â”‚
â”‚ â”‚ í‰ê·  ì‘ë‹µ ì‹œê°„: 245ms               â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚ [ğŸ“Š ìƒì„¸ ë¡œê·¸] [ğŸ”„ ìˆ˜ë™ ë¦¬ì…‹]                â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 4.3 ì˜ëª»ëœ ì¸ë±ì‹± ë°°í¬ ì‹œ ë¡¤ë°±

#### Aliasë¥¼ í™œìš©í•œ Blue-Green ë°°í¬

```bash
# 1. ì‹ ê·œ ì¸ë±ìŠ¤ ìƒì„± (ë²„ì „ v2)
PUT /bookclub_assets_v2
{
  "settings": { ... },
  "mappings": { ... }
}

# 2. ë°ì´í„° ì¬ì¸ë±ì‹± (ë°±ê·¸ë¼ìš´ë“œ)
POST /_reindex?wait_for_completion=false
{
  "source": {
    "index": "bookclub_assets_v1"
  },
  "dest": {
    "index": "bookclub_assets_v2"
  }
}

# 3. Alias ì „í™˜ (ì›ìì  ì—°ì‚°)
POST /_aliases
{
  "actions": [
    {
      "remove": {
        "index": "bookclub_assets_v1",
        "alias": "bookclub_assets"
      }
    },
    {
      "add": {
        "index": "bookclub_assets_v2",
        "alias": "bookclub_assets"
      }
    }
  ]
}

# 4. ê²€ì¦ í›„ ë¬¸ì œ ë°œê²¬ ì‹œ ì¦‰ì‹œ ë¡¤ë°±
POST /_aliases
{
  "actions": [
    {
      "remove": {
        "index": "bookclub_assets_v2",
        "alias": "bookclub_assets"
      }
    },
    {
      "add": {
        "index": "bookclub_assets_v1",
        "alias": "bookclub_assets"
      }
    }
  ]
}
# â†’ 1ì´ˆ ë‚´ ì´ì „ ë²„ì „ìœ¼ë¡œ ë³µêµ¬
```

---

#### ë°°í¬ ìë™í™” ìŠ¤í¬ë¦½íŠ¸

```python
# deploy_index.py
import requests
import time

class IndexDeployer:
    def __init__(self, es_host):
        self.es_host = es_host
        self.alias_name = 'bookclub_assets'

    def deploy_new_index(self, new_index, old_index):
        """ìƒˆ ì¸ë±ìŠ¤ ë°°í¬ (Blue-Green)"""

        # 1. ìƒˆ ì¸ë±ìŠ¤ ìƒì„± ë° ë°ì´í„° ë¡œë“œ
        print(f"Creating index: {new_index}")
        self.create_index(new_index)

        print(f"Reindexing from {old_index} to {new_index}")
        task_id = self.reindex(old_index, new_index)
        self.wait_for_reindex(task_id)

        # 2. í—¬ìŠ¤ ì²´í¬
        print("Health check...")
        if not self.health_check(new_index):
            raise Exception("Health check failed!")

        # 3. Canary í…ŒìŠ¤íŠ¸ (10% íŠ¸ë˜í”½)
        print("Canary deployment (10% traffic)...")
        self.add_canary_alias(new_index, weight=10)
        time.sleep(60)  # 1ë¶„ ëŒ€ê¸°

        if not self.verify_canary_metrics():
            print("Canary failed! Rolling back...")
            self.remove_canary_alias(new_index)
            raise Exception("Canary verification failed")

        # 4. ì „ì²´ íŠ¸ë˜í”½ ì „í™˜
        print("Switching all traffic...")
        self.switch_alias(old_index, new_index)

        # 5. ìµœì¢… ê²€ì¦
        time.sleep(30)
        if not self.verify_production_metrics():
            print("Production verification failed! Emergency rollback...")
            self.switch_alias(new_index, old_index)
            raise Exception("Production verification failed")

        print(f"âœ… Deployment complete: {new_index}")

        # 6. êµ¬ ì¸ë±ìŠ¤ ì‚­ì œ (7ì¼ í›„ ìë™)
        self.schedule_cleanup(old_index, days=7)

    def switch_alias(self, old_index, new_index):
        """Alias ì›ìì  ì „í™˜"""
        response = requests.post(
            f"{self.es_host}/_aliases",
            json={
                "actions": [
                    {"remove": {"index": old_index, "alias": self.alias_name}},
                    {"add": {"index": new_index, "alias": self.alias_name}}
                ]
            }
        )
        return response.json()

    def verify_production_metrics(self):
        """í”„ë¡œë•ì…˜ ì§€í‘œ ê²€ì¦"""
        # Kibana/CloudWatch ë©”íŠ¸ë¦­ í™•ì¸
        metrics = self.get_metrics(minutes=5)

        checks = {
            'error_rate': metrics['error_rate'] < 0.01,  # < 1%
            'response_time_p95': metrics['p95'] < 500,  # < 500ms
            'success_rate': metrics['success_rate'] > 0.99  # > 99%
        }

        passed = all(checks.values())
        print(f"Metrics check: {checks}")
        return passed
```

---

#### ë¡¤ë°± ì‹œí€€ìŠ¤ (30ì´ˆ ì´ë‚´)

```
[ë¬¸ì œ ê°ì§€]
   â†“
[ìë™ ì•ŒëŒ ë°œìƒ]
   - Slack: "#search-critical"
   - PagerDuty: On-call ì—”ì§€ë‹ˆì–´
   â†“
[ìˆ˜ë™ ë¡¤ë°± ê²°ì •] (ë˜ëŠ” ìë™)
   â†“
[Alias ì „í™˜ ì‹¤í–‰]
   POST /_aliases { ... }
   â†“ (1ì´ˆ ì†Œìš”)
[íŠ¸ë˜í”½ ì´ì „ ë²„ì „ìœ¼ë¡œ ë³µêµ¬]
   â†“
[ì‹ ê·œ ì¸ë±ìŠ¤ ë¶„ì„]
   - ë¡œê·¸ ìˆ˜ì§‘
   - ë¬¸ì œ ì›ì¸ íŒŒì•…
   â†“
[ìˆ˜ì • í›„ ì¬ë°°í¬]
```

---

## 5. êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

### 5.1 Phase 1: ì¸í”„ë¼ êµ¬ì¶• (1ì£¼)

- [ ] **OpenSearch í´ëŸ¬ìŠ¤í„° í”„ë¡œë¹„ì €ë‹**
  - [ ] AWS OpenSearch Domain ìƒì„± (3 ë…¸ë“œ, m5.large.search)
  - [ ] VPC ë‚´ Private Subnet ë°°ì¹˜
  - [ ] Security Group ì„¤ì • (Indexer ì„œë¹„ìŠ¤ë§Œ ì ‘ê·¼ í—ˆìš©)
  - [ ] IAM Role ìƒì„± ë° ì •ì±… ì—°ê²°

- [ ] **Kafka ì¸í”„ë¼ ê²°ì •**
  - [ ] AWS MSK vs EC2 ë¹„êµí‘œ ì‘ì„±
  - [ ] ì´ˆê¸° í† í”½ ìƒì„±: `bookclub.assets.changes`, `bookclub.assets.dlq`
  - [ ] Partition ìˆ˜ ê²°ì • (ê¶Œì¥: 3-5)

- [ ] **Indexer ì„œë¹„ìŠ¤ ë°°í¬ í™˜ê²½**
  - [ ] ECS Fargate Task Definition ì‘ì„±
  - [ ] Auto Scaling ì •ì±… (CPU > 70% ì‹œ ìŠ¤ì¼€ì¼ ì•„ì›ƒ)
  - [ ] CloudWatch Logs ê·¸ë£¹ ìƒì„±

---

### 5.2 Phase 2: ë°ì´í„° íŒŒì´í”„ë¼ì¸ (2ì£¼)

- [ ] **BCMS DB ìŠ¤í‚¤ë§ˆ í™•ì •**
  - [ ] `search_visibility`, `content_status` ë“± ì»¬ëŸ¼ ì¶”ê°€
  - [ ] ì¸ë±ìŠ¤ ì¶”ê°€: `idx_search_visibility`
  - [ ] ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ (`UPDATE assets SET search_visibility = 'auto'`)

- [ ] **CDC ì„¤ì •**
  - [ ] Debezium Connector ì„¤ì¹˜ ë° ì„¤ì •
  - [ ] Kafka Connect í´ëŸ¬ìŠ¤í„° ë°°í¬
  - [ ] ì´ˆê¸° ìŠ¤ëƒ…ìƒ· ìƒì„±

- [ ] **Indexer ì„œë¹„ìŠ¤ ê°œë°œ**
  - [ ] Kafka Consumer êµ¬í˜„
  - [ ] OpenSearch Bulk API ì—°ë™
  - [ ] ì¬ì‹œë„ ë¡œì§ ë° DLQ ì²˜ë¦¬
  - [ ] ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„± (ì»¤ë²„ë¦¬ì§€ > 80%)

---

### 5.3 Phase 3: ê²€ìƒ‰ API ê°œë°œ (2ì£¼)

- [ ] **API ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„**
  - [ ] `GET /api/v1/search` (ê¸°ë³¸ ê²€ìƒ‰)
  - [ ] `GET /api/v1/search/autocomplete` (ìë™ì™„ì„±)
  - [ ] `GET /api/v1/search/suggest` (ì˜¤íƒ€ êµì •)
  - [ ] OpenAPI 3.0 ìŠ¤í™ ë¬¸ì„œ ì‘ì„±

- [ ] **KRS ë¶€ìŠ¤íŒ… êµ¬í˜„**
  - [ ] `function_score` ì¿¼ë¦¬ ë¹Œë”
  - [ ] ì‚¬ìš©ì ë ˆë²¨ ê¸°ë°˜ í•„í„° í† ê¸€

- [ ] **ìºì‹± ë ˆì´ì–´**
  - [ ] Redis ì—°ë™ (ì¸ê¸° ê²€ìƒ‰ì–´ ìºì‹±)
  - [ ] TTL ì„¤ì • (5ë¶„)

---

### 5.4 Phase 4: ê´€ë¦¬ì í˜ì´ì§€ (1ì£¼)

- [ ] **ê²€ìƒ‰ ë…¸ì¶œ ê´€ë¦¬**
  - [ ] ìì¬ ìƒì„¸ í˜ì´ì§€ì— ê²€ìƒ‰ ì„¤ì • ì„¹ì…˜ ì¶”ê°€
  - [ ] `PATCH /api/admin/assets/{id}/search-visibility` API
  - [ ] ë³€ê²½ ì´ë ¥ ë¡œê·¸ í…Œì´ë¸” ìƒì„±

- [ ] **ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ**
  - [ ] Kibana ëŒ€ì‹œë³´ë“œ êµ¬ì„± (ì¸ê¸° ê²€ìƒ‰ì–´, ì‹¤íŒ¨ì–´)
  - [ ] DLQ ê´€ë¦¬ í˜ì´ì§€

---

### 5.5 Phase 5: í…ŒìŠ¤íŠ¸ ë° ë°°í¬ (2ì£¼)

- [ ] **PoC ê²€ì¦**
  - [ ] ì´ˆì„± ê²€ìƒ‰ ì •í™•ë„ í…ŒìŠ¤íŠ¸
  - [ ] KRS ë¶€ìŠ¤íŒ… ê²€ì¦
  - [ ] ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ (JMeter, 1000 QPS)

- [ ] **ë¶€í•˜ í…ŒìŠ¤íŠ¸**
  - [ ] Ramp-up: 0 â†’ 1000 users (10ë¶„)
  - [ ] Sustained: 1000 users (30ë¶„)
  - [ ] Spike: 3000 users (5ë¶„)

- [ ] **ë°°í¬**
  - [ ] Canary ë°°í¬ (10% â†’ 50% â†’ 100%)
  - [ ] Rollback ì ˆì°¨ ë¬¸ì„œí™”
  - [ ] ìš´ì˜ Runbook ì‘ì„±

---

### 5.6 Phase 6: ëª¨ë‹ˆí„°ë§ ë° ìµœì í™” (ì§€ì†)

- [ ] **ì•ŒëŒ ì„¤ì •**
  - [ ] ì¸ë±ì‹± ì§€ì—° > 5ë¶„
  - [ ] ê²€ìƒ‰ API ì—ëŸ¬ìœ¨ > 1%
  - [ ] Circuit Breaker Open ìƒíƒœ

- [ ] **A/B í…ŒìŠ¤íŠ¸**
  - [ ] KRS ê°€ì¤‘ì¹˜ ìµœì í™”
  - [ ] ê²€ìƒ‰ ê²°ê³¼ ê°œì„ 

---

## ğŸ“ ë¶€ë¡

### A. ì½”ë“œ ì €ì¥ì†Œ êµ¬ì¡°

```
bookclub-search/
â”œâ”€â”€ indexer-service/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ consumer.py       # Kafka Consumer
â”‚   â”‚   â”œâ”€â”€ indexer.py        # OpenSearch Indexer
â”‚   â”‚   â”œâ”€â”€ models.py         # ë°ì´í„° ëª¨ë¸
â”‚   â”‚   â””â”€â”€ config.py         # ì„¤ì •
â”‚   â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ requirements.txt
â”‚
â”œâ”€â”€ search-api/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”‚   â”œâ”€â”€ search.py
â”‚   â”‚   â”‚   â””â”€â”€ autocomplete.py
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”œâ”€â”€ opensearch.py
â”‚   â”‚   â”‚   â””â”€â”€ fallback.py
â”‚   â”‚   â””â”€â”€ utils/
â”‚   â”œâ”€â”€ tests/
â”‚   â””â”€â”€ Dockerfile
â”‚
â”œâ”€â”€ infrastructure/
â”‚   â”œâ”€â”€ terraform/
â”‚   â”‚   â”œâ”€â”€ opensearch.tf
â”‚   â”‚   â”œâ”€â”€ msk.tf
â”‚   â”‚   â””â”€â”€ ecs.tf
â”‚   â””â”€â”€ scripts/
â”‚       â”œâ”€â”€ deploy_index.py
â”‚       â””â”€â”€ rollback.sh
â”‚
â””â”€â”€ docs/
    â”œâ”€â”€ PRD.md
    â”œâ”€â”€ TECHNICAL_DESIGN.md (ì´ ë¬¸ì„œ)
    â””â”€â”€ RUNBOOK.md
```

---

### B. í™˜ê²½ ë³€ìˆ˜

```bash
# Indexer Service
KAFKA_BOOTSTRAP_SERVERS=kafka:9092
KAFKA_TOPIC=bookclub.assets.changes
KAFKA_GROUP_ID=opensearch-indexer

OPENSEARCH_HOST=opensearch.internal:9200
OPENSEARCH_USER=admin
OPENSEARCH_PASSWORD=secret
OPENSEARCH_INDEX=bookclub_assets_v1

DLQ_TOPIC=bookclub.assets.dlq
SLACK_WEBHOOK_URL=https://hooks.slack.com/...

# Search API
OPENSEARCH_HOST=opensearch.internal:9200
REDIS_HOST=redis:6379
CIRCUIT_BREAKER_THRESHOLD=5
CIRCUIT_BREAKER_TIMEOUT=60

DB_HOST=bcms-db.internal
DB_USER=readonly
DB_PASSWORD=secret
```

---

### C. ì°¸ê³  ìë£Œ

- [OpenSearch Nori Plugin ê°€ì´ë“œ](https://opensearch.org/docs/latest/analyzers/nori/)
- [Kafka Connect Debezium MySQL](https://debezium.io/documentation/reference/connectors/mysql.html)
- [Circuit Breaker íŒ¨í„´](https://martinfowler.com/bliki/CircuitBreaker.html)
- [AWS OpenSearch Best Practices](https://docs.aws.amazon.com/opensearch-service/latest/developerguide/bp.html)

---

**ë¬¸ì„œ ìƒíƒœ**: ğŸŸ¢ Ready for Development
**ë‹¤ìŒ ë‹¨ê³„**: Phase 1 ì¸í”„ë¼ êµ¬ì¶• ì°©ìˆ˜
**ì˜ˆìƒ ì™„ë£Œì¼**: 2025-04-10 (8ì£¼)
