# [PRD] 북클럽 3.0 통합검색 시스템 고도화

**문서 버전**: v1.0
**작성일**: 2025-02-10
**상태**: Draft → Review 필요

---

## 📋 목차

1. [프로젝트 배경 및 목적](#1-프로젝트-배경-및-목적)
2. [핵심 개편 요구사항](#2-핵심-개편-요구사항-the-game-changer)
3. [상세 기능 명세](#3-상세-기능-명세)
4. [기술 아키텍처](#4-기술-아키텍처-제언)
5. [기대 효과](#5-기대-효과)
6. [구현 우선순위](#6-구현-우선순위)
7. [리스크 및 고려사항](#7-리스크-및-고려사항)

---

## 1. 프로젝트 배경 및 목적

### 1.1 배경

기존 북클럽 2.0 검색 시스템은 **전시(CMS) 종속적 구조**로 인해 다음과 같은 한계를 가지고 있습니다:

- ❌ CMS에 전시 등록된 자재만 검색 가능
- ❌ 신규 콘텐츠 검색 노출까지 24시간 배치 대기
- ❌ 콘텐츠 업데이트가 즉시 반영되지 않음
- ❌ 운영팀의 전시 등록 작업에 대한 높은 의존성

### 1.2 목적

**자재(Asset) 중심의 독립적 인덱싱 체계 구축**을 통해:

1. ✅ 실시간 검색성 확보 (1분 이내 인덱싱)
2. ✅ 사용자 맞춤형 검색 경험 제공 (KRS 연동)
3. ✅ 운영 프로세스 간소화
4. ✅ 콘텐츠 도달률 극대화

---

## 2. 핵심 개편 요구사항 (The "Game Changer")

### 2.1 전시 종속성 완전 제거 (Decoupling)

#### As-Is
```
[BCMS 자재 등록] → [CMS 전시 등록] → [배치 인덱싱] → [검색 가능]
                      ↑ 병목 지점
```

#### To-Be
```
[BCMS 자재 등록] → [실시간 인덱싱] → [검색 가능]
                 ↓
          [검색 노출 플래그 체크]
```

**핵심 변경사항:**
- BCMS(자재 마스터) DB를 직접 인덱싱
- 전시 등록 여부와 무관하게 모든 유효 자재 검색 대상 편입
- 관리자 페이지에 **'검색 노출 여부'** 플래그 신설하여 별도 제어

**검색 노출 조건:**
```sql
WHERE status = 'ACTIVE'
  AND is_searchable = TRUE
  AND deleted_at IS NULL
```

---

### 2.2 실시간 인덱싱 파이프라인 구축

#### 배치 방식 탈피

| 항목 | As-Is (배치) | To-Be (Event-Driven) |
|------|-------------|---------------------|
| 갱신 주기 | 24시간 | 1분 이내 |
| 트리거 | Cron Job | Event (Create/Update/Delete) |
| 메커니즘 | Full Reindex | Incremental Update |
| 데이터 신선도 | 최대 24시간 지연 | 실시간 |

#### 아키텍처

```
[BCMS DB]
    ↓ (CDC - Change Data Capture)
[Kafka / AWS EventBridge]
    ↓ (Message Queue)
[Search Indexer Service]
    ↓ (Bulk API)
[AWS OpenSearch]
```

**구현 옵션:**
1. **Kafka Connect** (권장): Debezium CDC → Kafka → Indexer
2. **AWS DMS** + EventBridge: Database Migration Service 활용
3. **Application-Level**: API 호출 시 이벤트 발행 (Fallback)

---

### 2.3 개인화 랭킹 엔진 도입 (KRS 연동)

#### KRS Level Boosting

사용자의 KRS 레벨과 콘텐츠 권장 레벨 매칭 시 **가중치 부여**:

```json
{
  "query": {
    "function_score": {
      "query": { "match": { "title": "검색어" } },
      "functions": [
        {
          "filter": { "term": { "krs_level": "${user.krs_level}" } },
          "weight": 2.0
        },
        {
          "filter": { "range": { "krs_level": { "gte": "${user.krs_level - 1}", "lte": "${user.krs_level + 1}" } } },
          "weight": 1.5
        }
      ]
    }
  }
}
```

#### 맞춤형 필터

**기본 활성화:**
- '우리 아이 수준에 맞는 결과만 보기' 토글 (Default: ON)
- 사용자가 OFF 시 전체 결과 노출

**UI 예시:**
```
🔍 검색 결과 (전체 234개)
[✓] 우리 아이 수준에 맞는 도서만 보기 (KRS Lv.3 기준)
```

---

## 3. 상세 기능 명세

### 3.1 인덱싱 기능

| 구분 | 기능 | 요구사항 | 비즈니스 로직 및 제약사항 |
|------|------|----------|-------------------------|
| **메타데이터** | 확장 메타데이터 검색 | 제목, 저자 외 감상문 키워드, AI 태그, 본문 OCR 포함 | - OCR은 샘플 페이지 3장 이내<br>- AI 태그는 GPT-4 Vision 기반 자동 생성 |
| **형태소 분석** | Nori 형태소 분석기 | 한국어 특화 형태소 분석 및 전용 사전 관리 | - 도서명, 캐릭터명 커스텀 사전 등록<br>- 주기적 사전 업데이트 필요 |
| **자동완성** | 초성 검색 | 'ㅅㅂㅇㅍㅌ' 입력 시 '신비아파트' 자동완성 | - 자음만 추출하여 매칭<br>- 인기도 기반 상위 5개 추천 |
| **오타 교정** | Fuzzy Matching | '신비아파뜨' → '신비아파트' 자동 교정 | - Edit Distance 2 이내 허용<br>- 원본 검색어도 함께 표시 |

### 3.2 검색 결과 기능

| 구분 | 기능 | 요구사항 | 비즈니스 로직 |
|------|------|----------|---------------|
| **제로 결과 대응** | 추천 도서 노출 | 결과 없을 시 사용자 레벨 기반 추천 도서 강제 노출 | - KRS 레벨 ±1 범위 인기 도서<br>- '이런 도서는 어때요?' 섹션 |
| **필터링** | 다면 검색 | 연령, 장르, 출판사, 시리즈 필터 | - URL 쿼리스트링 유지<br>- 필터 조합 가능 |
| **정렬** | 정렬 옵션 | 관련도순, 최신순, 인기순 | - 기본값: 관련도순 (KRS 부스팅 포함) |
| **페이지네이션** | 무한 스크롤 | 20개씩 증분 로딩 | - 모바일 최적화<br>- 스크롤 위치 복원 |

### 3.3 관리자 기능

| 기능 | 설명 | 우선순위 |
|------|------|---------|
| **검색 노출 관리** | 자재별 검색 노출 여부 토글 | P0 (필수) |
| **인기 검색어 대시보드** | 실시간 검색어 트렌드 모니터링 | P1 (중요) |
| **검색 실패어 추적** | 결과 0건 검색어 수집 및 분석 | P1 (중요) |
| **동의어 관리** | 동의어 사전 등록/수정 | P2 (권장) |
| **수동 재인덱싱** | 특정 자재 또는 전체 재인덱싱 트리거 | P0 (필수) |

---

## 4. 기술 아키텍처 제언

### 4.1 검색 엔진

**선택: AWS OpenSearch v2.x**

**선정 이유:**
- ✅ Elasticsearch 호환 API
- ✅ AWS 관리형 서비스 (운영 효율성)
- ✅ Auto-scaling 지원
- ✅ 한국어 플러그인 (Nori) 내장
- ✅ Kibana 대시보드 통합

**대안 검토:**
| 옵션 | 장점 | 단점 | 결론 |
|------|------|------|------|
| Elasticsearch Self-hosted | 커스터마이징 자유도 | 운영 복잡도 높음 | ❌ 제외 |
| Algolia | 즉시 사용 가능 | 비용 높음, 커스터마이징 제약 | ❌ 제외 |
| Typesense | 오픈소스, 빠름 | 한국어 지원 약함 | ❌ 제외 |

### 4.2 인프라 구성

```
┌─────────────────────────────────────────────┐
│              AWS VPC (Private)              │
│                                             │
│  ┌─────────────┐      ┌─────────────┐     │
│  │   BCMS DB   │──┬──>│  Indexer    │     │
│  │  (RDS/Aurora)│  │   │  Service    │     │
│  └─────────────┘  │   └──────┬──────┘     │
│                   │          │             │
│                   │          ↓             │
│  ┌─────────────┐  │   ┌─────────────┐     │
│  │    Kafka    │──┘   │ OpenSearch  │     │
│  │  (MSK/EC2)  │      │   Cluster   │     │
│  └─────────────┘      └──────┬──────┘     │
│                              │             │
└──────────────────────────────┼─────────────┘
                               │
                        ┌──────▼──────┐
                        │  API Gateway │
                        │   (Public)   │
                        └─────────────┘
```

### 4.3 보안

- **VPC 내 독립 구성**: OpenSearch 클러스터는 Private Subnet에 배치
- **IAM 인증**: AWS IAM 역할 기반 접근 제어
- **암호화**: 전송 중(TLS) 및 저장 시(AES-256) 암호화
- **백업**: 자동 스냅샷 (일 1회, 7일 보관)

### 4.4 모니터링

**Kibana 대시보드:**
1. **실시간 검색어 순위** (Top 100)
2. **검색 실패어 목록** (결과 0건)
3. **평균 응답 시간** (p50, p95, p99)
4. **인덱싱 지연** (Event 발생 → 반영 소요 시간)
5. **에러율** (5xx 응답 비율)

**알람 설정:**
- 응답 시간 > 500ms (5분 지속)
- 에러율 > 1% (10분 지속)
- 인덱싱 지연 > 5분

---

## 5. 기대 효과

### 5.1 정량적 효과

| 지표 | 현재 (As-Is) | 목표 (To-Be) | 개선율 |
|------|-------------|-------------|-------|
| 검색 결과 반영 시간 | 평균 12시간 | 1분 이내 | **99.9%↓** |
| 검색 가능 자재 수 | 전시 등록 자재만 (~5,000건) | 전체 유효 자재 (~20,000건) | **300%↑** |
| 검색 정확도 (Precision) | 측정 미실시 | 80% 이상 | - |
| 검색 성공률 (결과 > 0) | 측정 미실시 | 95% 이상 | - |

### 5.2 정성적 효과

**사용자 측면:**
- 🎯 원하는 콘텐츠를 빠르게 발견
- 🔍 오타나 초성 검색으로 편의성 향상
- 👶 아이 수준에 맞는 결과만 노출

**운영 측면:**
- ⚙️ 전시 등록과 검색 인덱싱 분리로 프로세스 간소화
- 📊 데이터 기반 콘텐츠 기획 (검색어 분석)
- 🚀 신규 콘텐츠의 즉각적인 노출

**비즈니스 측면:**
- 💰 콘텐츠 소비 증가 → 이용 시간 증가
- 📈 사용자 만족도 향상 → 이탈률 감소
- 🎁 검색 데이터 기반 추천 시스템 고도화

---

## 6. 구현 우선순위

### Phase 1 (MVP - 2개월)
**목표:** 기본 검색 기능 구축 및 실시간 인덱싱

- [P0] AWS OpenSearch 클러스터 구축
- [P0] BCMS DB 직접 인덱싱 파이프라인
- [P0] 검색 API 개발 (기본 검색, 필터, 정렬)
- [P0] 관리자 페이지: 검색 노출 관리
- [P0] 실시간 인덱싱 (Kafka/EventBridge)

### Phase 2 (고도화 - 1개월)
**목표:** UX 개선 및 개인화

- [P1] 초성 검색 및 오타 교정
- [P1] KRS 레벨 기반 개인화 랭킹
- [P1] 자동완성 (Autocomplete)
- [P1] 검색어 분석 대시보드

### Phase 3 (최적화 - 1개월)
**목표:** 성능 최적화 및 운영 안정화

- [P2] 동의어 사전 관리
- [P2] AI 태그 자동 생성
- [P2] 본문 OCR 인덱싱
- [P2] A/B 테스트 프레임워크

---

## 7. 리스크 및 고려사항

### 7.1 기술적 리스크

| 리스크 | 영향도 | 발생 가능성 | 대응 방안 |
|--------|--------|-----------|----------|
| **인덱싱 지연** | 높음 | 중간 | - Kafka 파티션 확장<br>- 배치 인덱싱 Fallback |
| **검색 성능 저하** | 높음 | 낮음 | - 캐싱 레이어 (Redis)<br>- 쿼리 최적화 |
| **데이터 정합성** | 중간 | 중간 | - 재인덱싱 주기 (주 1회)<br>- 모니터링 알람 |
| **OpenSearch 장애** | 높음 | 낮음 | - Multi-AZ 구성<br>- 자동 Failover |

### 7.2 비즈니스 리스크

| 리스크 | 대응 방안 |
|--------|----------|
| **검색 노출 기준 모호** | - 명확한 검색 노출 정책 수립<br>- 관리자 가이드 문서화 |
| **KRS 레벨 부정확** | - KRS 레벨 갱신 주기 단축<br>- 수동 조정 기능 제공 |
| **검색 결과 품질** | - 초기 3개월간 집중 모니터링<br>- 사용자 피드백 수집 (검색 만족도 설문) |

### 7.3 운영 고려사항

**초기 데이터 마이그레이션:**
- 기존 CMS 검색 데이터 → OpenSearch 이관
- 예상 소요 시간: 2-3일 (2만 건 기준)
- 병렬 운영 기간: 2주 (기존 시스템과 비교 검증)

**모니터링 체크리스트:**
- [ ] 일일 인덱싱 성공률 > 99%
- [ ] 검색 API 응답 시간 < 300ms (p95)
- [ ] 검색 실패어(0건) 주간 리뷰
- [ ] OpenSearch 클러스터 Health: Green

**운영 매뉴얼 작성:**
- 검색 노출 관리 가이드
- 장애 대응 Runbook
- 인덱싱 파이프라인 모니터링 가이드
- 성능 튜닝 가이드

---

## 8. 다음 단계 (Next Steps)

### 8.1 즉시 진행 사항

1. **기술 검증 (PoC)** - 1주
   - [ ] OpenSearch 테스트 클러스터 구축
   - [ ] 샘플 데이터 1,000건 인덱싱 테스트
   - [ ] Nori 형태소 분석기 한국어 검색 정확도 검증

2. **상세 설계** - 2주
   - [ ] API 스펙 정의 (OpenAPI 3.0)
   - [ ] 데이터 모델 설계 (인덱스 스키마)
   - [ ] 인덱싱 파이프라인 상세 설계

3. **개발 착수** - 8주
   - [ ] Sprint 1-4: MVP 개발
   - [ ] Sprint 5-6: 고도화
   - [ ] Sprint 7-8: 안정화 및 성능 테스트

### 8.2 리뷰 및 승인 필요

- [ ] **비즈니스 오너**: 검색 노출 정책 확정
- [ ] **기술팀**: 아키텍처 리뷰 및 승인
- [ ] **운영팀**: 관리자 기능 요구사항 검증
- [ ] **경영진**: 예산 및 일정 승인

---

## 📎 부록

### A. 용어 정의

- **BCMS (Book Club Management System)**: 자재 마스터 시스템
- **CMS (Contents Management System)**: 전시 관리 시스템
- **KRS (Kid Reading Score)**: 독서 수준 측정 지표
- **CDC (Change Data Capture)**: 데이터 변경 캡처
- **OCR (Optical Character Recognition)**: 광학 문자 인식

### B. 참고 자료

- [AWS OpenSearch 공식 문서](https://docs.aws.amazon.com/opensearch-service/)
- [Elasticsearch Nori Plugin](https://www.elastic.co/guide/en/elasticsearch/plugins/current/analysis-nori.html)
- [Kafka Connect Debezium](https://debezium.io/)

### C. 변경 이력

| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|----------|
| v1.0 | 2025-02-10 | Claude | 초안 작성 |

---

**문서 상태**: 🟡 Review 필요
**다음 리뷰**: 2025-02-15
**승인자**: TBD
